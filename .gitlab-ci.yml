stages:
  - build
  - test
  - release
  - deploy

########################
# Variables globales
########################
variables:
  IMAGE_NAME: "mini-projet-gitlab"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  IMAGE_ARTIFACT: "mini-projet-gitlab.tar"
  HOST_PORT: 80
  CONTAINER_PORT: 80
  DOCKER_TLS_CERTDIR: ""

########################
# BUILD
########################
build:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
  script:
    - docker build --no-cache -t $IMAGE_NAME:$IMAGE_TAG .
    - docker save -o $IMAGE_ARTIFACT $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    paths:
      - $IMAGE_ARTIFACT
    expire_in: 1h

########################
# TEST
########################
.test_template: &test_template
  stage: test
  image: docker:latest
  services:
    - name: docker:dind
  before_script:
    - apk add --no-cache curl
  script:
    - docker load -i $IMAGE_ARTIFACT
    - docker run -d -p $HOST_PORT:$CONTAINER_PORT --name $IMAGE_NAME $IMAGE_NAME:$IMAGE_TAG
    - sleep 5
    - curl -f http://localhost
  after_script:
    - docker rm -f $IMAGE_NAME || true

test:
  <<: *test_template

########################
# RELEASE (Docker Hub)
########################
.release_template: &release_template
  stage: release
  image: docker:latest
  services:
    - name: docker:dind
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker load -i $IMAGE_ARTIFACT
    - docker tag $IMAGE_NAME:$IMAGE_TAG $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
    - docker push $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

release:
  <<: *release_template

########################
# DEPLOY TEMPLATE
########################
.deploy_template: &deploy_template
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d > /tmp/id_rsa
    - chmod 600 /tmp/id_rsa
    - ssh-add /tmp/id_rsa
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\nStrictHostKeyChecking=no\n" > ~/.ssh/config
  script:
    - |
      ssh $SERVER_USERNAME@$SERVER_IP "
        docker pull $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG &&
        docker rm -f $IMAGE_NAME || true &&
        docker run -d \
          --name $IMAGE_NAME \
          --restart unless-stopped \
          -p $HOST_PORT:$CONTAINER_PORT \
          $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
      "

########################
# DEPLOY REC
########################
deploy_rec:
  <<: *deploy_template
  variables:
    SERVER_IP: "$REC_SERVER_IP"
  environment:
    name: rec

########################
# DEPLOY PREPROD
########################
deploy_pprod:
  <<: *deploy_template
  variables:
    SERVER_IP: "$PPROD_SERVER_IP"
  environment:
    name: preprod

########################
# DEPLOY PROD
########################
deploy_prod:
  <<: *deploy_template
  variables:
    SERVER_IP: "$PROD_SERVER_IP"
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
